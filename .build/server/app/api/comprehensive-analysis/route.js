"use strict";(()=>{var e={};e.id=810,e.ids=[810],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},83863:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>A,patchFetch:()=>P,requestAsyncStorage:()=>w,routeModule:()=>x,serverHooks:()=>C,staticGenerationAsyncStorage:()=>T});var n,a={};i.r(a),i.d(a,{POST:()=>v,dynamic:()=>y});var s=i(49303),r=i(88716),o=i(60670),l=i(87070),c=i(9487);let m={tsh:{min:.5,max:2,unit:"\xb5IU/mL",description:"Thyroid Stimulating Hormone"},freeT4:{min:1.3,max:1.8,unit:"ng/dL",description:"Free Thyroxine"},freeT3:{min:3.2,max:4.4,unit:"pg/mL",description:"Free Triiodothyronine"},reverseT3:{min:9,max:24,unit:"ng/dL",description:"Reverse T3"},fastingGlucose:{min:72,max:85,unit:"mg/dL",description:"Fasting Glucose"},fastingInsulin:{min:2,max:5,unit:"\xb5IU/mL",description:"Fasting Insulin"},hba1c:{min:4.8,max:5.2,unit:"%",description:"Hemoglobin A1c"},totalCholesterol:{min:180,max:250,unit:"mg/dL",description:"Total Cholesterol"},hdl:{min:50,max:100,unit:"mg/dL",description:"HDL Cholesterol"},ldl:{min:70,max:150,unit:"mg/dL",description:"LDL Cholesterol"},triglycerides:{min:50,max:80,unit:"mg/dL",description:"Triglycerides"},hsCRP:{min:0,max:.5,unit:"mg/L",description:"High-Sensitivity C-Reactive Protein"},vitaminD:{min:50,max:80,unit:"ng/mL",description:"Vitamin D 25-OH"},vitaminB12:{min:500,max:1300,unit:"pg/mL",description:"Vitamin B12"},folate:{min:10,max:24,unit:"ng/mL",description:"Folate"},ferritin:{min:30,max:150,unit:"ng/mL",description:"Ferritin"},iron:{min:85,max:160,unit:"\xb5g/dL",description:"Iron"},transferrin:{min:250,max:380,unit:"mg/dL",description:"Transferrin"},magnesium:{min:2,max:2.6,unit:"mg/dL",description:"Magnesium"},zinc:{min:90,max:140,unit:"\xb5g/dL",description:"Zinc"},alt:{min:10,max:30,unit:"U/L",description:"Alanine Aminotransferase"},ast:{min:10,max:30,unit:"U/L",description:"Aspartate Aminotransferase"},alkalinePhosphatase:{min:70,max:120,unit:"U/L",description:"Alkaline Phosphatase"},creatinine:{min:.7,max:1.2,unit:"mg/dL",description:"Creatinine"},bun:{min:10,max:20,unit:"mg/dL",description:"Blood Urea Nitrogen"},wbc:{min:4.5,max:11,unit:"10\xb3/\xb5L",description:"White Blood Cells"},rbc:{min:4.2,max:5.4,unit:"10â¶/\xb5L",description:"Red Blood Cells"},hemoglobin:{min:13.5,max:17.5,unit:"g/dL",description:"Hemoglobin"},hematocrit:{min:40,max:52,unit:"%",description:"Hematocrit"},platelets:{min:150,max:450,unit:"10\xb3/\xb5L",description:"Platelets"}},d={thyroid:.4,metabolic:.3,inflammation:.15,nutrients:.15};function u(e,t){let i=t.filter(t=>e[t]);return 0===i.length?100:Math.round(i.reduce((t,i)=>t+(100-e[i].impact),0)/i.length)}var p=i(14749),h=i(30467),g=i(67297);async function f(e){try{let t=e.headers.get("authorization");t?.startsWith("Bearer "),e.cookies.get("session");return}catch(e){console.error("Failed to extract user ID:",e);return}}let y="force-dynamic",v=(n=async function(e){try{let t=await e.formData(),i=t.get("file"),n=t.get("email"),a=t.get("initials"),s=t.get("age"),r=t.get("city");if(!i||!n||!a||!s||!r)return l.NextResponse.json({error:"Missing required fields"},{status:400});let o=await c._.user.findUnique({where:{email:n},include:{userStats:!0}});if(o&&!await (0,h.cI)(o.id,"analysis"))return await p.Ps.logAnalysisRequest(o.id,"comprehensive",e,!1,"Insufficient consent for analysis operation"),l.NextResponse.json({error:"User consent required for health analysis"},{status:403});let f=await i.arrayBuffer(),y=Buffer.from(f).toString("base64"),v=await fetch("https://apps.abacus.ai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.ABACUSAI_API_KEY}`},body:JSON.stringify({model:"gpt-4.1-mini",messages:[{role:"user",content:[{type:"file",file:{filename:i.name,file_data:`data:application/pdf;base64,${y}`}},{type:"text",text:`Extract all biomarker values from this lab report and return them in JSON format. 
            
            Extract ALL available biomarkers including:
            - Thyroid Panel: TSH, Free T4, Free T3, Reverse T3, TPO Antibodies, Anti-Thyroglobulin
            - Metabolic Panel: Fasting Glucose, Fasting Insulin, HbA1c, C-Peptide, OGTT
            - Lipid Panel: Total Cholesterol, HDL, LDL, Triglycerides, ApoB, ApoA1, Lp(a)
            - Inflammation: hs-CRP, ESR, Ferritin, IL-6, TNF-alpha
            - Vitamins: Vitamin D, B12, Folate, B6, B1, B2, B3, B5, Biotin, Vitamin A, E, K
            - Minerals: Magnesium, Zinc, Iron, Copper, Selenium, Manganese, Chromium
            - Liver Function: ALT, AST, Alkaline Phosphatase, GGT, Total Bilirubin, Direct Bilirubin
            - Kidney Function: Creatinine, BUN, eGFR, Cystatin C, Microalbumin
            - Hormones: Cortisol, DHEA-S, Testosterone, Estradiol, Progesterone, IGF-1
            - Complete Blood Count: WBC, RBC, Hemoglobin, Hematocrit, Platelets, MCV, MCH, MCHC
            - Electrolytes: Sodium, Potassium, Chloride, CO2, Calcium, Phosphorus
            - Proteins: Total Protein, Albumin, Globulin, Prealbumin
            - Cardiac: Troponin, CK-MB, NT-proBNP, Homocysteine
            - Autoimmune: ANA, Anti-CCP, RF, Anti-dsDNA
            
            Return JSON with biomarker names as keys and numeric values only.
            Use consistent naming (e.g., "tsh", "freeT4", "fastingGlucose").
            
            If a biomarker is not present, don't include it in the JSON.
            Return only the JSON object, no other text.`}]}],max_tokens:3e3,response_format:{type:"json_object"}})});if(!v.ok)throw Error(`LLM API error: ${v.status}`);let x=await v.json(),w=JSON.parse(x.choices[0].message.content),T=function(e){let t={};Object.entries(e).forEach(([e,i])=>{null!=i&&(t[e]=function(e,t){let i,n,a;let s=m[e];if(!s)throw Error(`Unknown biomarker: ${e}`);if(t>=s.min&&t<=s.max)i="optimal",n="low",a=0;else if(t<s.min){let e=(s.min-t)/s.min*100;i="deficient",e>50?(n="critical",a=90):e>25?(n="high",a=70):e>10?(n="medium",a=40):(n="low",a=15)}else{let e=(t-s.max)/s.max*100;i="excessive",e>50?(n="critical",a=90):e>25?(n="high",a=70):e>10?(n="medium",a=40):(n="low",a=15)}let r=function(e,t,i){let n=[];switch(e){case"tsh":"excessive"===t&&(n.push("Consider thyroid support with natural desiccated thyroid"),n.push("Optimize iodine and tyrosine intake"),n.push("Reduce stress and support adrenal function"));break;case"freeT3":"deficient"===t&&(n.push("Support T4 to T3 conversion with selenium and zinc"),n.push("Reduce reverse T3 with stress management"),n.push("Consider T3 supplementation if needed"));break;case"fastingInsulin":"excessive"===t&&(n.push("Reduce refined carbohydrates and increase protein"),n.push("Incorporate intermittent fasting"),n.push("Add chromium and magnesium supplementation"));break;case"hsCRP":"excessive"===t&&(n.push("Identify and eliminate inflammatory triggers"),n.push("Increase omega-3 fatty acids and antioxidants"),n.push("Support gut health with probiotics"));break;case"vitaminD":"deficient"===t&&(n.push("Increase sun exposure and vitamin D3 supplementation"),n.push("Optimize magnesium and vitamin K2 cofactors"),n.push("Consider high-dose vitamin D3 with monitoring"))}return n}(e,i,0);return{value:t,optimal:s,status:i,severity:n,impact:a,recommendations:r}}(e,i))});let i=function(e){let t=u(e,["tsh","freeT4","freeT3","reverseT3"]),i=u(e,["fastingGlucose","fastingInsulin","hba1c","triglycerides","hdl"]),n=u(e,["hsCRP","ferritin"]),a=u(e,["vitaminD","vitaminB12","folate","magnesium","zinc"]);return{overall:Math.round(t*d.thyroid+i*d.metabolic+n*d.inflammation+a*d.nutrients),thyroid:t,metabolic:i,inflammation:n,nutrients:a}}(t),n=function(e){let t=[],i=[];e.tsh?.status==="excessive"&&i.push("Elevated TSH"),e.freeT3?.status==="deficient"&&i.push("Low Free T3"),e.reverseT3?.status==="excessive"&&i.push("Elevated Reverse T3"),i.length>=2&&t.push({type:"hypothyroid",severity:i.length>=3?"severe":"moderate",confidence:i.length/3,indicators:i,description:"Hypothyroid pattern detected with compromised metabolic function",recommendations:["Comprehensive thyroid evaluation with full panel","Consider natural desiccated thyroid or T3 supplementation","Support thyroid with iodine, selenium, and tyrosine","Address stress and adrenal function"],priority:"high"});let n=[];e.fastingInsulin?.status==="excessive"&&n.push("Elevated Fasting Insulin"),e.fastingGlucose?.status==="excessive"&&n.push("Elevated Fasting Glucose"),e.hba1c?.status==="excessive"&&n.push("Elevated HbA1c"),e.triglycerides?.status==="excessive"&&n.push("Elevated Triglycerides"),n.length>=2&&t.push({type:"insulin_resistance",severity:n.length>=3?"severe":"moderate",confidence:n.length/4,indicators:n,description:"Insulin resistance pattern with metabolic dysfunction",recommendations:["Reduce refined carbohydrates and increase protein intake","Incorporate intermittent fasting and time-restricted eating","Add chromium, magnesium, and alpha-lipoic acid supplementation","Increase physical activity and strength training"],priority:"high"});let a=[];return e.hsCRP?.status==="excessive"&&a.push("Elevated hs-CRP"),e.ferritin?.status==="excessive"&&a.push("Elevated Ferritin"),a.length>=1&&t.push({type:"inflammation",severity:e.hsCRP?.impact>70?"severe":"moderate",confidence:.8,indicators:a,description:"Chronic inflammation pattern detected",recommendations:["Identify and eliminate inflammatory triggers","Increase omega-3 fatty acids and antioxidants","Support gut health with probiotics and prebiotics","Consider anti-inflammatory herbs like turmeric and ginger"],priority:"medium"}),t}(t),a=function(e){let t=[];return Object.entries(e).sort(([,e],[,t])=>t.impact-e.impact).slice(0,10).forEach(([e,i],n)=>{i.impact>60?t.push({type:"critical",title:`${m[e]?.description||e} Dysfunction`,description:`${e} is ${i.status} with ${i.impact}% impact on metabolic health`,impact:i.impact,severity:i.severity,recommendations:i.recommendations,biomarkers:[e],priority:n+1}):i.impact>30?t.push({type:"important",title:`${m[e]?.description||e} Suboptimal`,description:`${e} needs attention with ${i.impact}% impact on metabolic health`,impact:i.impact,severity:i.severity,recommendations:i.recommendations,biomarkers:[e],priority:n+1}):"optimal"===i.status&&t.push({type:"strength",title:`${m[e]?.description||e} Optimal`,description:`${e} is in optimal range, supporting metabolic health`,impact:0,severity:"low",recommendations:["Continue current approach"],biomarkers:[e],priority:n+1})}),t.slice(0,8)}(t),s=function(e,t,i){let n=[],a=[],s=[];return i.filter(e=>"critical"===e.type).forEach(e=>{e.recommendations&&n.push(...e.recommendations.slice(0,1))}),t.forEach(e=>{a.push(...e.recommendations.slice(0,2))}),s.push("Regular monitoring and follow-up testing"),s.push("Comprehensive lifestyle optimization"),s.push("Working with healthcare practitioner for personalized protocol"),{immediate:[...new Set(n)].slice(0,5),shortTerm:[...new Set(a)].slice(0,5),longTerm:[...new Set(s)].slice(0,5)}}(0,n,a);return a.filter(e=>"strength"===e.type).map(e=>e.title).slice(0,3),a.filter(e=>"critical"===e.type||"important"===e.type).map(e=>e.title).slice(0,3),n.filter(e=>"high"===e.priority).map(e=>e.description).slice(0,3),{metabolicScore:i.overall,thyroidScore:i.thyroid,metabolicHealth:i.metabolic,inflammation:i.inflammation,nutrients:i.nutrients,biomarkers:t,patterns:n,criticalFindings:a,recommendations:s,summary:function(e,t,i){let n=e.overall>=80?"excellent":e.overall>=60?"good":e.overall>=40?"fair":"needs improvement",a=i.filter(e=>"critical"===e.type).length,s=t.length;return`Your metabolic health score is ${e.overall}/100 (${n}). ${a>0?`${a} critical areas need immediate attention. `:""}${s>0?`${s} metabolic patterns detected. `:""}Focus on the highest priority recommendations for optimal results.`}(i,n,a),optimization:function(e,t,i){let n=i.filter(e=>"critical"===e.type).map(e=>e.title).slice(0,3),a=[];return Object.entries(e).forEach(([e,t])=>{"deficient"===t.status&&t.impact>40&&a.push(`Consider ${e} supplementation with proper cofactors`)}),{priority:n,lifestyle:["Optimize sleep quality and duration","Manage stress through meditation or yoga","Regular moderate exercise and strength training"],nutrition:["Focus on whole foods and eliminate processed foods","Optimize protein intake and meal timing","Include anti-inflammatory foods and omega-3s"],supplementation:a.slice(0,3)}}(t,0,a)}}(w),C=await b(w,T);o||(o=await c._.user.create({data:{email:n,initials:a,age:parseInt(s),city:r,name:a},include:{userStats:!0}}),await c._.userStats.create({data:{userId:o.id}}),await c._.userRole_Assignment.create({data:{userId:o.id,role:"PATIENT",assignedBy:o.id,reason:"Default role assignment during analysis"}}));let A=(0,g.DM)(JSON.stringify(w)),P=await c._.analysis.create({data:{userId:o.id,email:n,initials:a,age:parseInt(s),city:r,biomarkers:w,metabolicScore:T.metabolicScore,thyroidScore:T.thyroidScore,metabolicHealth:T.metabolicHealth,inflammation:T.inflammation,nutrients:T.nutrients,patterns:T.patterns,criticalFindings:T.criticalFindings,recommendations:{...T.recommendations,aiInsights:C},analysisType:"comprehensive",aiEnhanced:!0,originalFilename:i.name,fileSize:i.size}});return await c._.encryptedPHI.create({data:{userId:o.id,fieldName:"biomarkers",encryptedData:A.encryptedData,keyVersion:A.keyVersion,sourceTable:"analyses",sourceId:P.id,dataType:"json",classification:"PHI"}}),await c._.userStats.update({where:{userId:o.id},data:{totalAnalyses:{increment:1},averageMetabolicScore:T.metabolicScore,bestMetabolicScore:Math.max(T.metabolicScore,o.userStats?.bestMetabolicScore||0),latestAnalysisDate:new Date}}),await p.Ps.logAnalysisRequest(o.id,"comprehensive",e,!0),await p.Ps.logDataAccess(o.id,"analysis",P.id,"write",e,{analysisType:"comprehensive",biomarkerCount:Object.keys(w).length,fileSize:i.size}),l.NextResponse.json({success:!0,analysisId:P.id,results:{...T,aiInsights:C},message:"Comprehensive analysis completed successfully"})}catch(i){console.error("Comprehensive analysis error:",i);let t=(await e.formData()).get("email");if(t){let n=await c._.user.findUnique({where:{email:t}});n&&await p.Ps.logAnalysisRequest(n.id,"comprehensive",e,!1,i.message)}return l.NextResponse.json({error:"Comprehensive analysis failed",details:i instanceof Error?i.message:"Unknown error"},{status:500})}},async(e,...t)=>{let i,a;let s=Date.now(),r=(0,g.tk)(16),o=await f(e),c=({userId:o,sessionId:r,startTime:s})(e).auditContext=c,m=!0;try{(i=await n(e,...t)).status>=400&&(m=!1,a=`HTTP ${i.status}`)}catch(e){m=!1,a=e.message,i=l.NextResponse.json({error:"Internal server error"},{status:500})}try{await p.Ps.logEvent({userId:o,sessionId:r,eventType:"data_access",resource:function(e){let t=e.split("/").filter(Boolean);return t.includes("health-assessment")?"health_assessment":t.includes("biomarker")?"biomarker":t.includes("analysis")?"analysis":t.includes("user")||t.includes("profile")?"user_profile":t.includes("auth")?"auth":(t.includes("admin"),"system")}(e.nextUrl.pathname),action:function(e){switch(e.toUpperCase()){case"GET":default:return"read";case"POST":return"create";case"PUT":case"PATCH":return"update";case"DELETE":return"delete"}}(e.method),ipAddress:function(e){let t=e.headers.get("x-forwarded-for"),i=e.headers.get("x-real-ip");return t?t.split(",")[0].trim():i||"unknown"}(e),userAgent:e.headers.get("user-agent")||void 0,endpoint:e.nextUrl.pathname,method:e.method,success:m,errorMessage:a,dataAccessed:{responseTime:Date.now()-s,statusCode:i.status}})}catch(e){console.error("Audit logging failed:",e)}return i});async function b(e,t){try{let i=await fetch("https://apps.abacus.ai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.ABACUSAI_API_KEY}`},body:JSON.stringify({model:"gpt-4.1-mini",messages:[{role:"user",content:`Based on this comprehensive lab analysis, provide advanced insights and personalized recommendations:

Biomarker Data: ${JSON.stringify(e)}
Analysis Results: ${JSON.stringify(t)}

Please provide:
1. Advanced pattern recognition beyond basic analysis
2. Personalized optimization strategies
3. Risk assessment and prevention recommendations
4. Integration insights (how biomarkers interact)
5. Lifestyle and nutritional recommendations
6. Monitoring and follow-up suggestions

Focus on actionable insights that go beyond standard lab interpretation.`}],max_tokens:2e3})});if(i.ok)return(await i.json()).choices[0].message.content;return"AI insights temporarily unavailable. Please refer to the comprehensive analysis results."}catch(e){return console.error("AI insights generation error:",e),"AI insights temporarily unavailable. Please refer to the comprehensive analysis results."}}let x=new s.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/comprehensive-analysis/route",pathname:"/api/comprehensive-analysis",filename:"route",bundlePath:"app/api/comprehensive-analysis/route"},resolvedPagePath:"/home/ubuntu/labinsight-ai-complete/app/api/comprehensive-analysis/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:w,staticGenerationAsyncStorage:T,serverHooks:C}=x,A="/api/comprehensive-analysis/route";function P(){return(0,o.patchFetch)({serverHooks:C,staticGenerationAsyncStorage:T})}},9487:(e,t,i)=>{i.d(t,{_:()=>a});var n=i(53524);let a=globalThis.prisma??new n.PrismaClient({log:["query","info","warn","error"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),n=t.X(0,[276,972,753],()=>i(83863));module.exports=n})();